<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Note</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600&family=Karla:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            font-family: 'Karla', sans-serif;
            padding: 20px;
        }

        .no-paper-message {
            text-align: center;
            padding: 40px;
            max-width: 400px;
        }

        .no-paper-message h1 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 16px;
        }

        .no-paper-message p {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .note-container {
            width: 100%;
            max-width: 500px;
        }

        .note-paper {
            background: var(--paper-color, white);
            border-radius: 4px;
            box-shadow: 
                0 1px 3px rgba(0,0,0,0.08),
                0 8px 24px rgba(0,0,0,0.08);
            padding: 24px;
            position: relative;
        }

        .note-paper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                transparent,
                transparent 27px,
                rgba(0,0,0,0.03) 28px
            );
            pointer-events: none;
            border-radius: 4px;
        }

        .name-field {
            margin-bottom: 16px;
        }

        .name-field label {
            display: block;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 6px;
        }

        .name-field input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Karla', sans-serif;
            font-size: 1rem;
            background: rgba(255,255,255,0.7);
        }

        .name-field input:focus {
            outline: none;
            border-color: #999;
        }

        .writing-area {
            position: relative;
        }

        .writing-area textarea {
            width: 100%;
            min-height: 250px;
            border: none;
            background: transparent;
            font-family: 'Caveat', cursive;
            font-size: var(--font-size, 1.4rem);
            line-height: 1.6;
            color: var(--pen-color, #333);
            resize: vertical;
            padding: 8px 4px;
        }

        .writing-area textarea:focus {
            outline: none;
        }

        .writing-area textarea::placeholder {
            color: var(--pen-color, #333);
            opacity: 0.4;
        }

        .constraints-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0,0,0,0.08);
            font-size: 0.85rem;
            color: #888;
        }

        .word-count {
            transition: color 0.2s;
        }

        .word-count.warning {
            color: #e67e22;
            font-weight: 500;
        }

        .word-count.exceeded {
            color: #e74c3c;
            font-weight: 500;
        }

        .banned-warning {
            display: none;
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 8px;
            padding: 8px 12px;
            background: #fdf2f2;
            border-radius: 4px;
        }

        .banned-warning.visible {
            display: block;
        }

        .submit-section {
            margin-top: 20px;
        }

        .submit-btn {
            width: 100%;
            padding: 14px 24px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            font-family: 'Karla', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .submit-btn:hover {
            background: #444;
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .success-message {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .success-message.visible {
            display: block;
        }

        .success-message h2 {
            color: #27ae60;
            font-size: 1.5rem;
            margin-bottom: 12px;
        }

        .success-message p {
            color: #666;
        }

        .note-form.hidden {
            display: none;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 12px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        /* Font size variations */
        .font-xs textarea { font-size: 0.9rem; }
        .font-small textarea { font-size: 1.1rem; }
        .font-medium textarea { font-size: 1.4rem; }
        .font-large textarea { font-size: 1.8rem; }
        .font-xl textarea { font-size: 5.8rem; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="note-container">
        <!-- No paper variation -->
        <!-- No paper variation -->
        <div class="no-paper-message" id="noPaper" style="display: none;">
            <div id="noPaperNameForm">
                <div class="name-field">
                    <label for="noPaperName">Your name or pseudonym</label>
                    <input type="text" id="noPaperName" placeholder="Enter your name...">
                </div>
                <button class="submit-btn" id="noPaperSubmitBtn" style="margin-top: 16px;">Continue</button>
            </div>
             <div id="noPaperResult" style="display: none;">
                <h1>üòï</h1>
                <p>Sorry, it looks like you didn't receive any paper for this activity.</p>
    </div>
</div>
        <div class="no-paper-message" id="noPaper" style="display: none;">
            <h1>üòï</h1>
            <p>Sorry, it looks like you didn't receive any paper for this activity.</p>
        </div>

        <!-- Main note form -->
        <div class="note-form" id="noteForm">
            <div class="note-paper" id="notePaper">
                <div class="name-field">
                    <label for="participantName">Your name or pseudonym</label>
                    <input type="text" id="participantName" placeholder="Enter your name...">
                </div>
                
                <div class="writing-area" id="writingArea">
                    <textarea 
                        id="noteText" 
                        placeholder="Write your note here..."
                    ></textarea>
                </div>

                <div class="banned-warning" id="bannedWarning">
                    ‚ö†Ô∏è Your note contains a word or phrase that isn't allowed: <strong id="bannedWord"></strong>
                </div>

                <div class="constraints-bar">
                    <span class="word-count" id="wordCount">0 words</span>
                    <span class="word-limit" id="wordLimit"></span>
                </div>
            </div>

            <div class="submit-section">
                <button class="submit-btn" id="submitBtn">Submit Note</button>
                <div class="error-message" id="errorMessage"></div>
            </div>
        </div>

        <!-- Success message -->
        <div class="success-message" id="successMessage">
            <h2>‚úì Note Submitted!</h2>
            <p>Thank you for your contribution.</p>
        </div>
    </div>

    <script>
        // Parse URL parameters
        const params = new URLSearchParams(window.location.search);
        
        // Configuration from URL
        const config = {
            paperColor: params.get('bg') || 'white',
            penColor: params.get('text') || '#333333',
            wordLimit: params.get('limit') ? parseInt(params.get('limit')) : null,
            fontSize: params.get('size') || 'medium',
            banned: params.get('banned') ? params.get('banned').toLowerCase().split(',').map(w => w.trim()) : [],
            noPaper: params.get('nopaper') === 'true',
            noPen: params.get('nopen') === 'true',
            sheetUrl: params.get('sheet') || '' // Google Apps Script Web App URL
        };

        // Color mappings for friendly names
        const colorMap = {
            'white': '#ffffff',
            'yellow': '#fff9c4',
            'blue': '#bbdefb',
            'pink': '#f8bbd9',
            'green': '#c8e6c9',
            'orange': '#ffe0b2',
            'purple': '#e1bee7',
            'gray': '#eeeeee',
            'black': '#333333',
            'darkblue': '#1565c0',
            'darkpink': '#e091b0'
        };

        // Font size mappings
        const fontSizeMap = {
            'xs': 'font-xs',
            'small': 'font-small',
            'medium': 'font-medium',
            'large': 'font-large',
            'xl': 'font-xl'
        };

        // Get actual color value
        function getColor(color) {
            return colorMap[color.toLowerCase()] || color;
        }

        // Initialize the page
        function init() {
            const noteForm = document.getElementById('noteForm');
            const noPaperMsg = document.getElementById('noPaper');
            const notePaper = document.getElementById('notePaper');
            const writingArea = document.getElementById('writingArea');
            const textarea = document.getElementById('noteText');
            const wordCountEl = document.getElementById('wordCount');
            const wordLimitEl = document.getElementById('wordLimit');

            // Handle no paper variation
            if (config.noPaper) {
                noteForm.style.display = 'none';
                noPaperMsg.style.display = 'block';
                return;
            }

            // Apply paper color
            const paperColor = getColor(config.paperColor);
            notePaper.style.setProperty('--paper-color', paperColor);

            // Apply pen color (or make it same as paper if noPen)
            let penColor = config.noPen ? paperColor : getColor(config.penColor);
            writingArea.style.setProperty('--pen-color', penColor);

            // Apply font size
            const fontClass = fontSizeMap[config.fontSize] || 'font-medium';
            writingArea.classList.add(fontClass);

            // Show word limit
            if (config.wordLimit) {
                wordLimitEl.textContent = `Limit: ${config.wordLimit} words`;
            } else {
                wordLimitEl.textContent = '';
            }

            // Word count and validation
            textarea.addEventListener('input', function() {
                const text = this.value.trim();
                const words = text ? text.split(/\s+/).length : 0;
                
                wordCountEl.textContent = `${words} word${words !== 1 ? 's' : ''}`;
                
                // Check word limit
                if (config.wordLimit) {
                    wordCountEl.classList.remove('warning', 'exceeded');
                    if (words > config.wordLimit) {
                        wordCountEl.classList.add('exceeded');
                    } else if (words > config.wordLimit * 0.9) {
                        wordCountEl.classList.add('warning');
                    }
                }

                // Check banned words
                checkBannedWords(text);
            });

            // Submit handler
            document.getElementById('submitBtn').addEventListener('click', submitNote);
        }

        function checkBannedWords(text) {
            const warningEl = document.getElementById('bannedWarning');
            const bannedWordEl = document.getElementById('bannedWord');
            
            if (config.banned.length === 0) {
                warningEl.classList.remove('visible');
                return true;
            }

            const lowerText = text.toLowerCase();
            for (const banned of config.banned) {
                if (lowerText.includes(banned)) {
                    bannedWordEl.textContent = banned;
                    warningEl.classList.add('visible');
                    return false;
                }
            }

            warningEl.classList.remove('visible');
            return true;
        }

        async function submitNote() {
            const name = document.getElementById('participantName').value.trim();
            const text = document.getElementById('noteText').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            const errorEl = document.getElementById('errorMessage');

            // Validation
            if (!name) {
                errorEl.textContent = 'Please enter your name or pseudonym.';
                errorEl.classList.add('visible');
                return;
            }

            if (!text) {
                errorEl.textContent = 'Please write something before submitting.';
                errorEl.classList.add('visible');
                return;
            }

            // Check word limit
            const words = text.split(/\s+/).length;
            if (config.wordLimit && words > config.wordLimit) {
                errorEl.textContent = `Your note exceeds the ${config.wordLimit} word limit.`;
                errorEl.classList.add('visible');
                return;
            }

            // Check banned words
            if (!checkBannedWords(text)) {
                errorEl.textContent = 'Your note contains words or phrases that aren\'t allowed.';
                errorEl.classList.add('visible');
                return;
            }

            // Check if sheet URL is configured
            if (!config.sheetUrl) {
                errorEl.textContent = 'Submission endpoint not configured. Please contact the workshop facilitator.';
                errorEl.classList.add('visible');
                return;
            }

            errorEl.classList.remove('visible');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            // Prepare data
            const data = {
                name: name,
                text: text,
                paperColor: config.paperColor,
                penColor: config.noPen ? config.paperColor : config.penColor,
                fontSize: config.fontSize,
                wordLimit: config.wordLimit || '',
                banned: config.banned.join(','),
                timestamp: new Date().toISOString()
            };

            try {
                // Submit to Google Apps Script
                await fetch(config.sheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                // Show success (we can't check response with no-cors, but it usually works)
                document.getElementById('noteForm').classList.add('hidden');
                document.getElementById('successMessage').classList.add('visible');

            } catch (error) {
                errorEl.textContent = 'Failed to submit. Please try again.';
                errorEl.classList.add('visible');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Note';
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
